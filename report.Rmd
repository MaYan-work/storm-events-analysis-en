---
title: "Assignment 4 ETC5513"
author: "XXXX"
output:
  pdf_document:
    citation_package: natbib
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
bibliography: references.bib 
biblio-style: plainnat
subtitle: Team name
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center} 
  \includegraphics[width=5in,height=6in]{Images/sam-albury-oA7MMRxTVzo-unsplash.jpg}\LARGE\\}
- \posttitle{\end{center}}
- \usepackage{fontawesome}
- \usepackage[most]{tcolorbox}
- \usepackage{xcolor}
- \usepackage{sectsty}
- \sectionfont{\color{blue}}
- \usepackage{verbatim}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning= FALSE)
```

```{r libraries}
library(tidyverse)
library(knitr)
library(readr)
library(lubridate)
library(bookdown)
```

```{r cleaning-data}
# read data
storm17 <- read_csv("data/StormEvents_details-ftp_v1.0_d2017_c20200121.csv")
storm18 <- read_csv("data/StormEvents_details-ftp_v1.0_d2018_c20200317.csv")
storm19 <- read_csv("data/StormEvents_details-ftp_v1.0_d2019_c20200516.csv")

# change date format
clean <- function(x) {
x$BEGIN_DATE_TIME <- dmy_hms(x$BEGIN_DATE_TIME) 
x$END_DATE_TIME <- dmy_hms(x$END_DATE_TIME)
x$BEGIN_DAY <- mday(x$BEGIN_DATE_TIME)
x$END_DAY <- mday(x$END_DATE_TIME)
x$BEGIN_TIME <- format(as.POSIXct(x$BEGIN_DATE_TIME) ,format = "%H:%M:%S") 
x$END_TIME <- format(as.POSIXct(x$END_DATE_TIME) ,format = "%H:%M:%S") 
x$MONTH_NAME <- month(x$BEGIN_DATE_TIME, label=TRUE)

#unselect column with NA value; unselect BEGIN MONTH and END MONTH because there are already MONTH column
x <- x %>% select(-BEGIN_YEARMONTH, -END_YEARMONTH, -EPISODE_ID, -WFO, -CZ_TIMEZONE, -SOURCE, -MAGNITUDE_TYPE,-CATEGORY, -FLOOD_CAUSE,-TOR_OTHER_WFO,- TOR_OTHER_CZ_STATE, -TOR_OTHER_CZ_FIPS, - TOR_OTHER_CZ_NAME, - BEGIN_AZIMUTH, -BEGIN_LOCATION, -END_AZIMUTH, -END_LOCATION, -EPISODE_NARRATIVE, -EVENT_NARRATIVE, -DATA_SOURCE) 
}

storm17 <- clean(storm17)
storm18 <- clean(storm18)
storm19 <- clean(storm19)
storm_all <- rbind(storm17,storm18,storm19)
```

\clearpage

# Introduction

\clearpage

# Methodology

\clearpage

# Section 1
From the Table \@ref(tab:stormtb) the top 10 numbers of storm events in America are all concentrate in 2017 and 2019 in the past three years. The thunderstorm wind happened most frequently, which is 18617 cases in 2019 and 16472 cases in 2017, after that is hail followed by 10398 in 2017 and 9013 in 2019.
```{r stormtb, echo=FALSE}
event19 <- storm19 %>%
  select(EVENT_TYPE, YEAR) %>%
  group_by(EVENT_TYPE, YEAR) %>%  
  summarise(count=n())

event18 <- storm18 %>%
  select(EVENT_TYPE, YEAR) %>%
  group_by(EVENT_TYPE, YEAR)

event17 <- storm17 %>%
  select(EVENT_TYPE, YEAR) %>%
  group_by(EVENT_TYPE, YEAR) %>%  
  summarise(count=n())

events_3years <- merge(merge(event19, event18, all=TRUE), event17, all=TRUE)%>%
  arrange(desc(count))%>%
  head(10)

knitr::kable(events_3years, caption = "Top10 storm events in 3 years ")
```

Table \@ref(tab:countstb) shows the top 10 numbers of storm events happened  in America in 2019. first of all is thunderstorm wind happened 18617 times, after that is hail with 9013 cases and flood with 4949 cases and flash flood followed by 4072 cases. The other six are winter weather, high wind, winter storm, heavy snow, marine thunderstorm wind and tornado in order.
```{r countstb, echo=FALSE}
event_counts <- storm19 %>%
  select(STATE, EVENT_TYPE, BEGIN_LAT, BEGIN_LON) %>%
  group_by(EVENT_TYPE) %>%
  summarise(count=n())%>%
  arrange(desc(count))%>%
  head(5)

knitr::kable(event_counts, caption = "Top5 storm event frequency in 2019")
```

Figure  \@ref(fig:locationmap) shows the distributions of the most frequently happened five storm events' locations in 2019. It is clear to see that theses storm events happened more in eastern of America and some in the middle of America. 
```{r locationmap, fig.cap = "Top5 storm event locations in 2019", echo=FALSE, fig.align = "center"}
library(ggmap)
library(ggthemes)
library(ggplot2)
usa_bbox <- c(-130,
              20,
              -60,
              50)
usa_map <- get_map(location = usa_bbox, source = "osm")
storm_locations <- data.frame(storm19 %>%
  select(STATE, EVENT_TYPE, BEGIN_LAT, BEGIN_LON) %>%
  filter(EVENT_TYPE %in%c("Thunderstorm Wind", 
                    "Hail",
                    "Flood",
                    "Flash Flood",
                    "Winter Weather"),
         BEGIN_LON != "NA",
         BEGIN_LAT != "NA"))
ggmap(usa_map) +
  geom_point(data= storm_locations, aes(x= BEGIN_LON, y = BEGIN_LAT, color = EVENT_TYPE),
              alpha = 0.3, size = 0.5) +
  theme_map()
```

As for thunderstorm wind, Figure  \@ref(fig:TMmonth) shows the thunderstorm wind locations in America in 2019 of different months. It is clear to see that the most active months of thunderstorm wind were from May to August. Furthermore, the locations of theses events happened from middle and east of America slowly transformed to the east from July to October. 
```{r TWmonth, fig.cap = "Thunderstorm locations by month in 2019", echo=FALSE, fig.align = "center"}
Thunderstorm_locations <- data.frame(storm19 %>%
  select(STATE, EVENT_TYPE, MONTH_NAME, BEGIN_LAT, BEGIN_LON) %>%
  filter(EVENT_TYPE %in%c("Thunderstorm Wind"),
         BEGIN_LON != "NA",
         BEGIN_LAT != "NA"))
         
ggmap(usa_map) +
  geom_point(data= Thunderstorm_locations, aes(x= BEGIN_LON, y = BEGIN_LAT),
             color = "blue",alpha = 0.1, size = 0.3) +
  facet_wrap(~ MONTH_NAME)
```

Table \@ref(tab:statestb) displayed the number of thunderstorm wind happed in different states of America in 2019. As we can see from the table, except for Kansas, Texas and Missouri, the top ten states are all located in the east of America.
```{r statestb, echo=FALSE}
thunderstorm_counts <- storm19 %>%
    filter(EVENT_TYPE %in%c("Thunderstorm Wind")) %>%
  select(STATE, EVENT_TYPE, DEATHS_DIRECT, BEGIN_LAT, BEGIN_LON) %>%
  group_by(STATE) %>%
  summarise(count=n())%>%
  arrange(desc(count))%>%
  head(10)

knitr::kable(thunderstorm_counts, caption = "Top10 states by number of thunderstorm in 2019")
```

Figure \@ref(fig:monthplot) shows that the number of  thunderstorm wind occurred in different states by month. The thunderstorm wind most frequently happened from May to August. However the peak of the number of such cases were different from some states, August is the peak month of some eastern America states like New York, Pennsylvania and Virginia, for the middle of America states like Texas and Missouri, the peak months were May and June.
```{r monthplot, fig.cap = "The nuber of thunderstorm events of top10 states in diffenrent month", echo=FALSE, fig.align = "center"}
thunderstorm_time <- storm19 %>%
    filter(EVENT_TYPE %in%c("Thunderstorm Wind")) %>%
  select(STATE, EVENT_TYPE, MONTH_NAME) %>%
  filter(EVENT_TYPE %in%c("Thunderstorm Wind"),
         STATE %in%c("PENNSYLVANIA",
                     "VIRGINIA",
                     "TEXAS",
                     "NEW YORK",
                     "OHIO",
                     "KANSAS",
                     "NORTH CAROLINA",
                     "GEORGIA",
                     "MISSOURI",
                     "SOUTH CAROLINA")) %>%
  group_by(MONTH_NAME, STATE) %>%
  summarise(count=n())%>%
ggplot(aes(x = MONTH_NAME, y = count)) +
  geom_point() +
  facet_wrap(~ STATE)
thunderstorm_time
```



\clearpage

# Section 2


\clearpage

# Section 3


\clearpage

# Section 4

\clearpage

# Conclusion

\clearpage

# Citation examples

[More styles for natbib here](https://www.overleaf.com/learn/latex/Natbib_bibliography_styles)


 @BC64 and this is another article about COVID @bai2020presumed and I can also cite R packages as follows @ggplot2
