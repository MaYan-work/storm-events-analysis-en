---
title: "Assignment 4 ETC5513"
author: "XXXX"
output:
  pdf_document:
    citation_package: natbib
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
bibliography: references.bib 
biblio-style: dinat
subtitle: Team name
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center} 
  \includegraphics[width=5in,height=6in]{Images/sam-albury-oA7MMRxTVzo-unsplash.jpg}\LARGE\\}
- \posttitle{\end{center}}
- \usepackage{fontawesome}
- \usepackage[most]{tcolorbox}
- \usepackage{xcolor}
- \usepackage{sectsty}
- \sectionfont{\color{blue}}
- \usepackage{verbatim}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning= FALSE)
```

```{r libraries}
library(tidyverse)
library(knitr)
library(readr)
library(lubridate)
library(bookdown)
library(kableExtra)
library(gridExtra)
theme_set(theme_minimal())
```

```{r cleaning-data}
# read data
storm17 <- read_csv("data/StormEvents_details-ftp_v1.0_d2017_c20200121.csv")
storm18 <- read_csv("data/StormEvents_details-ftp_v1.0_d2018_c20200317.csv")
storm19 <- read_csv("data/StormEvents_details-ftp_v1.0_d2019_c20200516.csv")

# change date format
clean <- function(x) {
x$BEGIN_DATE_TIME <- dmy_hms(x$BEGIN_DATE_TIME) 
x$END_DATE_TIME <- dmy_hms(x$END_DATE_TIME)
x$BEGIN_DAY <- mday(x$BEGIN_DATE_TIME)
x$END_DAY <- mday(x$END_DATE_TIME)
x$BEGIN_TIME <- format(as.POSIXct(x$BEGIN_DATE_TIME) ,format = "%H:%M:%S") 
x$END_TIME <- format(as.POSIXct(x$END_DATE_TIME) ,format = "%H:%M:%S") 
x$MONTH_NAME <- month(x$BEGIN_DATE_TIME, label=TRUE)

#unselect column with NA value; unselect BEGIN MONTH and END MONTH because there are already MONTH column
x <- x %>% select(-BEGIN_YEARMONTH, -END_YEARMONTH, -EPISODE_ID, -WFO, -CZ_TIMEZONE, -SOURCE, -MAGNITUDE_TYPE,-CATEGORY, -FLOOD_CAUSE,-TOR_OTHER_WFO,- TOR_OTHER_CZ_STATE, -TOR_OTHER_CZ_FIPS, - TOR_OTHER_CZ_NAME, - BEGIN_AZIMUTH, -BEGIN_LOCATION, -END_AZIMUTH, -END_LOCATION, -EPISODE_NARRATIVE, -EVENT_NARRATIVE, -DATA_SOURCE) 
}

storm17 <- clean(storm17)
storm18 <- clean(storm18)
storm19 <- clean(storm19)
storm_all <- rbind(storm17,storm18,storm19)
```

\clearpage

# Introduction

\clearpage

# Data

## Data source

We download the dataset from Storm Events Database data set which contains 31 variables and 187139 observations in total from NOAA <https://www.ncdc.noaa.gov/stormevents/>.

## Data limitation

One of the defects of this dataset is that there is no further division of the scale of disasters, because the losses, casualties and even distribution areas caused by disasters of different scales are different, for example, it is quite difficult to distinguish between small versus large hail through this dataset. So, if there is a further division of the scale of disasters, it will be more conducive to analysis.

\clearpage

# Methodology

\clearpage

# Section 1


\clearpage

# Section 2


\clearpage

# Section 3

## The trend of occurence of the top five most frequent events changing by year 

In this section, the main purpose is to explore the trend of occurence of the top five most frequent events changing by year both across the whole USA and in each state. First, create a table and group the data by "STATE" and "YEAR". Then count the times of occurence for all events and rename the name of this column as "FREQ" to present the frequency. And next, create a new table to arrange the data by descending order with displaying the top 5 events that happen most frequently. Then, use "right_join" to connect these two tables. Finally, create two figures to display the trend of occurence of the top 5 event changing by year.
```{r frequencytrend, echo = FALSE}
storm_frequency_state <- storm_all %>%
  group_by(STATE, YEAR) %>%
  count(EVENT_TYPE) %>%
  rename(FREQ = n) 
```

```{r tablefrequency, echo = FALSE}
kable(storm_frequency_state[1:10,],
      booktabs = TRUE, 
      caption = "The frequency of the events") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F,
                latex_options = c("hold_position"))
```


```{r frequencytrendnew, echo = FALSE}
storm_frequency_state_new <- storm_all %>%
  group_by(EVENT_TYPE) %>%
  count(EVENT_TYPE) %>%
  rename(FREQ = n) %>%
  arrange(desc(FREQ))%>%
  head(5) %>%
  select(EVENT_TYPE)
```

```{r tablefrequencynew, echo = FALSE}
kable(storm_frequency_state_new[1:5,],
      booktabs = TRUE, 
      caption = "Top five most frequent events") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F,
                latex_options = c("hold_position"))
```

```{r topnewtable, echo = FALSE}
top5_newtable <- right_join(storm_frequency_state, storm_frequency_state_new, by = "EVENT_TYPE") %>%
  group_by(STATE)
```

```{r rightjointable, echo = FALSE}
kable(top5_newtable[1:10,],
      booktabs = TRUE, 
      caption = "Occurence of top five most frequent events") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = F,
                latex_options = c("hold_position"))
```

```{r  frequencyplot,fig.height = 30, fig.width= 30, echo = FALSE, fig.cap="Occurence of top five most frequent events changing by year"}
ggplot(top5_newtable,
       aes(x= YEAR, 
           y = FREQ, group = EVENT_TYPE, color = EVENT_TYPE)) +
  geom_line() +
  scale_y_log10() +
  theme(
  legend.title = element_text(color = "blue", size = 60),
  legend.text = element_text(color = "green", size = 60),
  axis.title.x = element_text(size = 40),
  axis.title.y = element_text(size = 40),
  axis.text.x = element_text(size = 30),
  axis.text.y = element_text(size = 30)
  )
```


Table \@ref(tab:tablefrequency) displays the first ten lines of the frequency of all events. And Table \@ref(tab:tablefrequencynew) displays the top five most frequent events. And Table \@ref(tab:rightjointable) displays the first ten lines of the final results of the occurence of top five most frequent events. It can be seen that top 5 events have occurred in some regions in three years for example, thunderstorm wind has occurred in Alabama in three yearsfrom 495 times to 630 times , while it has only occurred twice in Alaska in 2019.
Figure \@ref(fig:frequencyplot) presents the occurence of top five most frequent events across the whole USA, we could see that thunderstorm wind showed an increasing trend during three years. And hail showed a slow growth in 2017-2018, followed by a sharp decline in 2018-2019. As for the winter weather, it has been on a downward trend for three years, but the slowdown from 2017 to 2018 was larger than that from 2018 to 2019. What's more, flash flood kept growing, but slowed down between 2018 and 2019. At last, flood kept a slow decline at first, then turned into a significant rise. 
We could see that most events have a similar trend, but hail has decreased in 2018 to 2019 years, which is possibly due to increased melting level heights and greater atmospheric instability.[@dessensberthetsanchez2015] Correspondingly, the number of floods increased from 2018 to 2019, which is increasingly common due to years of relative sea level increases and El Nino.[@floodingdaysin2018]

\clearpage

# Section 4

\clearpage

# Conclusion

\clearpage

# Citation examples

[More styles for natbib here](https://www.overleaf.com/learn/latex/Natbib_bibliography_styles)


 @BC64 and this is another article about COVID @bai2020presumed and I can also cite R packages as follows @ggplot2
