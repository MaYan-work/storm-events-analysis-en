---
title: "Assignment 4 ETC5513"
author: "Yan Ma"
output:
  bookdown::pdf_document2:
    citation_package: natbib
    highlight: tango
    number_sections: yes
    toc: yes
    toc_depth: 2
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '2'
bibliography: references.bib 
biblio-style: plainnat
subtitle: Team name
header-includes:
- \usepackage{titling}
- \pretitle{\begin{center} 
  \includegraphics[width=5in,height=6in]{Images/sam-albury-oA7MMRxTVzo-unsplash.jpg}\LARGE\\}
- \posttitle{\end{center}}
- \usepackage{fontawesome}
- \usepackage[most]{tcolorbox}
- \usepackage{xcolor}
- \usepackage{sectsty}
- \sectionfont{\color{blue}}
- \usepackage{verbatim}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning= FALSE)
```

```{r libraries}
library(tidyverse)
library(knitr)
library(readr)
library(lubridate)
library(bookdown)
```

```{r cleaning-data}
# read data
storm17 <- read_csv("data/StormEvents_details-ftp_v1.0_d2017_c20200121.csv")
storm18 <- read_csv("data/StormEvents_details-ftp_v1.0_d2018_c20200317.csv")
storm19 <- read_csv("data/StormEvents_details-ftp_v1.0_d2019_c20200516.csv")

# change date format
clean <- function(x) {
x$BEGIN_DATE_TIME <- dmy_hms(x$BEGIN_DATE_TIME) 
x$END_DATE_TIME <- dmy_hms(x$END_DATE_TIME)
x$BEGIN_DAY <- mday(x$BEGIN_DATE_TIME)
x$END_DAY <- mday(x$END_DATE_TIME)
x$BEGIN_TIME <- format(as.POSIXct(x$BEGIN_DATE_TIME) ,format = "%H:%M:%S") 
x$END_TIME <- format(as.POSIXct(x$END_DATE_TIME) ,format = "%H:%M:%S") 
x$MONTH_NAME <- month(x$BEGIN_DATE_TIME, label=TRUE)

#unselect column with NA value; unselect BEGIN MONTH and END MONTH because there are already MONTH column
x <- x %>% select(-BEGIN_YEARMONTH, -END_YEARMONTH, -EPISODE_ID, -WFO, -CZ_TIMEZONE, -SOURCE, -MAGNITUDE_TYPE,-CATEGORY, -FLOOD_CAUSE,-TOR_OTHER_WFO,- TOR_OTHER_CZ_STATE, -TOR_OTHER_CZ_FIPS, - TOR_OTHER_CZ_NAME, - BEGIN_AZIMUTH, -BEGIN_LOCATION, -END_AZIMUTH, -END_LOCATION, -EPISODE_NARRATIVE, -EVENT_NARRATIVE, -DATA_SOURCE) 
}

storm17 <- clean(storm17)
storm18 <- clean(storm18)
storm19 <- clean(storm19)
storm_all <- rbind(storm17,storm18,storm19)
```

\clearpage

# Introduction

\clearpage

# Methodology

\clearpage

# Section 1


\clearpage

# Section 2


\clearpage

# Section 3


\clearpage

# Section 4: Injuries and Deaths

This section will focus on the injuries and deaths caused by the storm events and other unusual weather phenomena across the US from 2017 to 2019.

## Direct injuries and deaths by month and year

Figure \@ref(fig:fig1) and \@ref(fig:fig2) shows the total direct injuries and deaths of the storm events by month. 

Over all the years, there are less direct injuries of storm events from September to December, while more direct injuries happened on January June and July. Most direct deaths happened on January, June to September and November.

There are several noticeable time periods. First, there are over 500 injuries and over 200 deaths on July 2018. Second, over 100 deaths happened on November 2018.  

```{r fig1, fig.cap = "Total direct injuries by month"}
storm_all %>% 
  group_by(YEAR, MONTH_NAME) %>% 
  mutate(injury_tot = sum(INJURIES_DIRECT)) %>% 
  ggplot(aes(x = MONTH_NAME, y = injury_tot, fill = MONTH_NAME)) + 
  geom_col(position = "dodge") + 
  coord_flip() + 
  facet_grid(~ YEAR) + 
  guides(fill=FALSE) + 
  ggtitle("Total direct injuries by month")
```

```{r fig2, fig.cap = "Total direct deaths by month"}
storm_all %>% 
  group_by(YEAR, MONTH_NAME) %>% 
  mutate(death_tot = sum(DEATHS_DIRECT)) %>% 
  ggplot(aes(x = MONTH_NAME, y = death_tot, fill = MONTH_NAME)) + 
  geom_col(position = "dodge") + 
  coord_flip() + 
  facet_grid(~ YEAR) + 
  guides(fill=FALSE) + 
  ggtitle("Total direct deaths by month")
```

\clearpage

## Direct injuries and deaths by state

Figure \@ref(fig:fig3) shows the direct injuries of each state through 2017 to 2019. In 2017, Georgia had over 150 direct injuries which is the most among all the states. In 2018, California had over 350 direct injuries which is the most among all the states. Meanwhile, Oklahoma and Missouri also had over 200 direct injuries. The most injuries in 2019 happened in Ohio, with over 200 injuries.


```{r fig3, fig.cap = "Total direct injuries by state", fig.height=8}
storm_all %>% 
  group_by(YEAR, STATE) %>% 
  mutate(injury_tot_state = sum(INJURIES_DIRECT)) %>% 
  arrange(injury_tot_state) %>% 
  ggplot(aes(x = STATE, y = injury_tot_state, fill = STATE)) + 
  geom_col(position = "dodge") + 
  coord_flip() + 
  facet_grid(~ YEAR) + 
  guides(fill=FALSE) + 
  ggtitle("Total direct injuries by state") + 
  theme(axis.text.x = element_text(size=12), 
        axis.text.y = element_text(size=6)) 
```

\clearpage

Figure \@ref(fig:fig4) shows the direct deaths of each state through 2017 to 2019. In 2017, Texas had about 100 direct deaths, which is the most among all the states. In 2018, Arizona had over 150 direct deaths and California had about 150 direct deaths, which are more than other states. In 2019, no state had more than 50 direct deaths, and Texas is slightly higher than others.


```{r fig4, fig.cap = "Total direct deaths by state", fig.height=8}
storm_all %>% 
  group_by(YEAR, STATE) %>% 
  mutate(death_tot_state = sum(DEATHS_DIRECT)) %>% 
  ggplot(aes(x = STATE, y = death_tot_state, fill = STATE)) + 
  geom_col(position = "dodge") + 
  coord_flip() + 
  facet_grid(~ YEAR) + 
  guides(fill=FALSE) + 
  ggtitle("Total direct deaths by state") + 
  theme(axis.text.x = element_text(size=12), 
        axis.text.y = element_text(size=6))
```

\clearpage


## Direct injuries and deaths by major event type

Table \@ref(tab:tab1) shows the top 5 types of events with most direct injuries from 2017 to 2019. And figure \@ref(fig:fig5) shows the injuries they caused every year. Tornado caused most direct injuries in 2017 and 2019, while heat caused more direct injuries than other types of events in 2018.

```{r tab1, tab.cap = "Major event types cause direct injuries over years"}
library(kableExtra)
storm_all %>% 
  group_by(EVENT_TYPE) %>% 
  summarise(injury_event = sum(INJURIES_DIRECT)) %>% 
  arrange(desc(injury_event)) %>% 
  head(5) %>% 
  kable(caption = "Major event types cause direct injuries over years",  booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

major_types_injury <- c("Tornado", "Heat", "Thunderstorm Wind", "Excessive Heat", "Lightning")
```

```{r fig5, fig.cap = "Total direct injuries by event type"}
storm_all %>% 
  filter(EVENT_TYPE == major_types_injury) %>% 
  group_by(YEAR, EVENT_TYPE) %>% 
  mutate(injury_tot_type = sum(INJURIES_DIRECT)) %>% 
  ggplot(aes(x = EVENT_TYPE, y = injury_tot_type, fill = EVENT_TYPE)) + 
  geom_col(position = "dodge") + 
  facet_wrap(~ YEAR) + 
  guides(fill=FALSE) + 
  ggtitle("Total direct injuries by event type") + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```

\clearpage

Table \@ref(tab:tab2) shows the top 5 types of events with most direct deaths from 2017 to 2019. And figure \@ref(fig:fig6) shows the deaths they caused every year. Excessive Heat caused most direct deaths among the five major event types in 2018, while flash flood caused slightly more direct deaths in 2017 and 2019. In addition, direct deaths caused by wildfire is decreasing in this time period. 

```{r tab2, tab.cap = "Major event types cause deaths over years"}
library(kableExtra)
storm_all %>% 
  group_by(EVENT_TYPE) %>% 
  summarise(death_event = sum(DEATHS_DIRECT)) %>% 
  arrange(desc(death_event)) %>% 
  head(5) %>% 
  kable(caption = "Major event types cause deaths over years",  booktabs = T) %>% 
  kable_styling(latex_options = c("striped", "hold_position"))

major_types_death <- c("Excessive Heat", "Flash Flood", "Heat", "Rip Current", "Wildfire")
```

```{r fig6, fig.cap = "Total direct deaths by event type"}
storm_all %>% 
  filter(EVENT_TYPE == major_types_death) %>% 
  group_by(YEAR, EVENT_TYPE) %>% 
  mutate(death_tot_type = sum(DEATHS_DIRECT)) %>% 
  ggplot(aes(x = EVENT_TYPE, y = death_tot_type, fill = EVENT_TYPE)) + 
  geom_col(position = "dodge") + 
  facet_wrap(~ YEAR) + 
  guides(fill=FALSE) + 
  ggtitle("Total direct injuries by event type") + 
  theme(axis.text.x = element_text(angle=90, hjust=1))
```


\clearpage

# Conclusion

Over all the years, there are less direct injuries of storm events from September to December, while more direct injuries happened on January June and July. Most direct deaths happened on January, June to September and November.

In 2017, Georgia had the most direct injuries and Texas had the most direct deaths among all the states. In 2018, California had the most direct injuries and Arizona had the most direct deaths among all the states. In 2019, no state had more than 50 direct deaths, and Texas is slightly higher than others while Ohio had the most direct injuries. 

Tornado caused most injuries in 2017 and 2019, while heat caused more injuries than other types of events in 2018. Excessive Heat caused most direct deaths among the five major event types in 2018, while flash flood caused slightly more direct deaths in 2017 and 2019. In addition, direct deaths caused by wildfire is decreasing in this time period.


\clearpage

# Citation examples

[More styles for natbib here](https://www.overleaf.com/learn/latex/Natbib_bibliography_styles)


 @BC64 and this is another article about COVID @bai2020presumed and I can also cite R packages as follows @ggplot2
